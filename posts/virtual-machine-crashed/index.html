<!DOCTYPE html>
<html>
  <head>
    
    
    
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>
      
  Virtual Machine Crashed &ndash; DevOps journey

    </title>
    
    <meta content="vmware, machine, virtual" name="keywords">
    
    
    <meta name="description" property="og:description" content="Virtual machine out of control Does not turn off! On a typical day in a DevOps it is very likely that it will have to create or manage virtual machines, sometimes very important because production processes are running on them. Very often, it happens that maintenance, you have to restart or shut down these machines to move them to site or host.
One of the most used virtual machine managers is ESxi from vmware.|">
    

    <meta name="apple-mobile-web-app-title" content="DevOps journey">
    
    
    <link rel="icon" href="https://matteoguadrini.github.iofavicon-64.png">
    <link rel="apple-touch-icon" href="https://matteoguadrini.github.ioapple-touch-icon.png">
    <link rel="mask-icon" size="any" href="https://matteoguadrini.github.iopinned-icon.svg">
    
    
    


    <link rel="stylesheet" href="/assets/syntax.css">
    <link rel="stylesheet" href="/assets/primer-build.css">
    <link rel="stylesheet" href="/assets/style.css">
    <link rel="stylesheet" href="/assets/custom_style.css">
  </head>


  <body class="bg-gray">
    <div id="holy" class="container-lg bg-white h-100">

      <div id="header" class="px-1 bg-white">
        <nav class="UnderlineNav UnderlineNav--right px-2">
  <a class="UnderlineNav-actions muted-link h2" href="https://matteoguadrini.github.io">
    DevOps journey
  </a>

  
  
  <div class="UnderlineNav-body">
    
    
    
    <a class="UnderlineNav-item" href="/about/">
      
      <span>About</span>
    </a>
    
    
    
    
    <a class="UnderlineNav-item" href="/tools/">
      
      <span>Tools</span>
    </a>
    
    
  </div>
  
</nav>

      </div>

      <div role="main" id="main" class="holy-main markdown-body px-4 bg-white">
        

<div class="Subhead">
  <div class="Subhead-heading">
    <div class="h1 mt-3 mb-1">Virtual Machine Crashed</div>
  </div>
  <div class="Subhead-description">
    


<a href='/categories/bash' class="muted-link">
  <span class="Label Label--gray-darker">bash</span>
</a>

<a href='/categories/virtual' class="muted-link">
  <span class="Label Label--gray-darker">virtual</span>
</a>



<a href='/tags/system' class="muted-link">
  <span class="Label Label--gray">System</span>
</a>



    
    <div class="float-md-right">
      <span title="Lastmod: 2021-11-07. Published at: 2021-11-07.">
        
          Published: 2021-11-07
        
      </span>
    </div>
    
  </div>
</div>
<article>
  
  <section class="pb-6 mb-3 border-bottom">
    <p><img src="https://www.vmware.com/content/dam/digitalmarketing/vmware/en/images/gallery/thumbnails/tn-vsphere-overview-hypervisor.jpg" alt="vm"></p>
<h2 id="virtual-machine-out-of-control">Virtual machine out of control</h2>
<h3 id="does-not-turn-off">Does not turn off!</h3>
<p>On a typical day in a DevOps it is very likely that it will have to create or manage virtual machines, sometimes very important because production processes are running on them. Very often, it happens that maintenance, you have to restart or shut down these machines to move them to site or host.</p>
<p>One of the most used virtual machine managers is ESxi from vmware.</p>
<p>Unfortunately, ESxi suffers from a virtual memory bug that sometimes does not allow virtual machines to be shut down or restarted (reset), having the impression of no longer having control of them.</p>
<h3 id="lets-try-it-from-the-command-line">Let&rsquo;s try it from the command line</h3>
<p>As in all things, the command line always comes up against us. Having a cli, for any tool, is a prerequisite for solving problems, when the graphical interface for one reason or another does not come out.</p>
<p>The first thing to do is check the logs. If you see one of these lines in the vsphere logs (<code>/var/log/vmware/vsphere-ui/logs</code>), then we need to proceed as follows in the article:</p>
<ul>
<li>Soap error 999. The operation is not allowed in current state</li>
<li>The attempted operation cannot be performed in the current state (Powered Off)</li>
<li>The request refers to an object that no longer exists or has never existed</li>
</ul>
<h3 id="lets-intercept-the-problem">Let&rsquo;s intercept the problem</h3>
<p>First, you need to log in as root on <em>ESxI host</em> to start the cli.
After that, get a list of all registered virtual machines, identified by their <strong>VMID</strong> and <strong>Display Name</strong> by running this command:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="gp"># </span>vim-cmd vmsvc/getallvms
</code></pre></div><p>Take note of the impacted virtual machine ID VMID.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="gp"># </span>vim-cmd vmsvc/power.getstate &lt;VMID&gt;
</code></pre></div><p>Check if there hanging task on the impacted virtual machine that prevent the machine from powering on by running this command:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="gp"># </span>vim-cmd vmsvc/get.tasklist &lt;VMID&gt;
</code></pre></div><p>An example output will look like this:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="go">(ManagedObjectReference) [
</span><span class="go">&#39;vim.Task:haTask-2-vim.VirtualMachine.createSnapshot-182550283&#39;,
</span><span class="go">&#39;vim.Task:haTask-2-vim.VirtualMachine.consolidateDisks-182550274&#39;
</span><span class="go">]
</span></code></pre></div><p>Now we need to figure out which task is blocking other operations such as shutdown.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="gp"># </span>vim-cmd vimsvc/task_info haTask-2-vim.VirtualMachine.createSnapshot-182550283
</code></pre></div><p>The task is hung and needs to be cancelled, use the command:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="gp"># </span>vim-cmd vimsvc/task_cancel &lt;task_id&gt;
</code></pre></div><p>Now, shutdown the virtual machine using the VMID and run this command:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="gp"># </span>vim-cmd vmsvc/power.shutdown &lt;VMID&gt;
</code></pre></div><blockquote>
<p><strong>Note</strong>: If the virtual machine fails to shut down, run this command:</p>
</blockquote>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="gp"># </span>vim-cmd vmsvc/power.off &lt;VMID&gt;
</code></pre></div><h2 id="conclusion">Conclusion</h2>
<p>In this article, we have seen how to restart a virtual machine locked by the vmware host. Of course you should never use this procedure under normal conditions, but you know, errors and exceptions are always around the corner.</p>

  </section>

  <section>
    
      
    
  </section>
</article>

      </div>

      <div id="side" class="pr-1 bg-white">
        <aside class="pr-3">
          
  
    <div id="toc" class="Box Box--blue mb-3">
      <b>Virtual Machine Crashed</b><nav id="TableOfContents">
  <ul>
    <li><a href="#virtual-machine-out-of-control">Virtual machine out of control</a>
      <ul>
        <li><a href="#does-not-turn-off">Does not turn off!</a></li>
        <li><a href="#lets-try-it-from-the-command-line">Let&rsquo;s try it from the command line</a></li>
        <li><a href="#lets-intercept-the-problem">Let&rsquo;s intercept the problem</a></li>
      </ul>
    </li>
    <li><a href="#conclusion">Conclusion</a></li>
  </ul>
</nav></div>
  

  
    
    
      <div>
        
          <a href="https://twitter.com/share?ref_src=twsrc%5Etfw" class="twitter-share-button" data-show-count="false">Tweet</a><script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
        

        
          <iframe src="https://www.facebook.com/plugins/share_button.php?href=https%3A%2F%2Fdevelopers.facebook.com%2Fdocs%2Fplugins%2F&layout=button&size=small&mobile_iframe=true&width=61&height=20&appId" width="61" height="20" style="border:none;overflow:hidden" scrolling="no" frameborder="0" allowTransparency="true" allow="encrypted-media"></iframe>
        

        

        
          <a data-pocket-label="pocket" data-pocket-count="none" class="pocket-btn" data-lang="en"></a>
          <script type="text/javascript">!function(d,i){if(!d.getElementById(i)){var j=d.createElement("script");j.id=i;j.src="https://widgets.getpocket.com/v1/j/btn.js?v=1";var w=d.getElementById(i);d.body.appendChild(j);}}(document,"pocket-btn-js");</script>
        

      </div>
    
  

        </aside>
      </div>

      <div id="footer" class="pt-2 pb-3 bg-white text-center">
        

  <span class="text-small text-gray">
    Â© Matteo Guadrini &middot; 

    Powered by the
    <a href="https://github.com/qqhann/hugo-primer" class="link-gray-dark">Hugo-Primer</a> theme for
    <a href="https://gohugo.io" class="link-gray-dark">Hugo</a>.
  </span>


      </div>
    </div>

    
    
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/x-mathjax-config">MathJax.Hub.Config({ tex2jax: { inlineMath: [['$','$'], ['\\(','\\)']] } });</script>
    
  </body>
</html>
